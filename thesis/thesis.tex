%==========================================
%
% Academic thesis template
%
% Based on KOMA-Script book class.
%
% This template is not officially endorsed 
% by any educational institution.
%
% Ben Swift   22/6/12
% benjamin.j.swift@gmail.com
% http://github.com/benswift/thesis-template
% 
% This template is in the public domain
% 
%==========================================
% preamble
\documentclass[oneside,11pt,xetex]{scrbook}
\KOMAoptions{%
  headings=normal,
  captions=rightbeside,
  bibliography=totoc,
  listof=totoc}

%\usepackage{libertineotf}
\usepackage{amsmath}
\newcommand{\argmax}[1]{\underset{#1}{\operatorname{argmax}}}

\usepackage{fontspec}
\setmonofont[Scale=MatchLowercase,Mapping=tex-text]{Tahoma}

\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{listings}
% if you want colour tables
% \usepackage{colortbl}

\usepackage[svgnames,hyperref]{xcolor}

\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\graphicspath{{./figures/}}

\usepackage[margin=10pt,labelfont=bf]{caption}
\usepackage[labelformat=simple]{subcaption}
\renewcommand\thesubfigure{(\alph{subfigure})}

\usepackage{metalogo}
\usepackage{hologo}
\usepackage{verbatim}
\usepackage{setspace}
\usepackage{enumitem}

\newlist{transcriptlist}{description}{1}
\setlist[transcriptlist]{font=\sffamily\bfseries,
                              align=left,
                              leftmargin=1.6cm,
                              labelindent=\parindent, 
                              labelwidth=*}

\newenvironment{transcript}%
{\small\begin{transcriptlist}}%
{\end{transcriptlist}}

\newlist{headinglist}{description}{1}
\setlist[headinglist]{font=\sffamily\bfseries, 
                           leftmargin=0cm,
                           style=nextline}

\usepackage[%
backend=biber,
natbib=true,
backref=true,
citecounter=true,
dashed=false,
backrefstyle=three,
citestyle=authoryear-icomp,
firstinits=true,
maxcitenames=2,
maxbibnames=10,
uniquename=mininit,
bibstyle=authoryear,
url=false,
doi=false]{biblatex}

\AtEveryBibitem{\clearfield{month}}
\AtEveryCitekey{\clearfield{month}}

\nocite{*}
\addbibresource[datatype=bibtex]{thesis.bib}

\usepackage[english=british,threshold=15,thresholdtype=words]{csquotes}
\SetCiteCommand{\parencite}

\newenvironment*{smallquote}
  {\quote\small}
  {\endquote}
\SetBlockEnvironment{smallquote}

\usepackage[%
unicode=true,
hyperindex=true,
bookmarks=true,
pdftitle={Beyond .*Script},
pdfauthor={Veit Heller},
colorlinks=false,
pdfborder=0,
allcolors=DarkBlue,
pdfpagelabels,
hyperfootnotes=true]{hyperref}

\usepackage{bookmark}

\setcounter{tocdepth}{1}

\usepackage[%
acronym, 
nomain,
toc=true]{glossaries}

\usepackage{cleveref}

\newacronym{ast}{AST}{Abstract Syntax Tree}
\newacronym{ir}{IR}{Intermediate Representation}
\newacronym{ghc}{GHC}{Glasgow Haskell Compiler}
\newacronym{repl}{REPL}{Read-Eval-Print Loop}
\newacronym{ffi}{FFI}{Foreign Function Interface}
\newacronym{api}{API}{Application Programming Interface}
\newacronym{dom}{DOM}{Document Object Model}
\newacronym{w3c}{W3C}{World Wide Web Consortium}

\renewcommand{\thepage}{\roman{page}}

\makeindex
\makeglossaries


\usepackage{color}
\definecolor{lightgray}{rgb}{.9,.9,.9}
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}
\lstdefinelanguage{JavaScript}{
  keywords={break, case, catch, continue, debugger, default, delete, do, else, false, finally, for, function, if, in, instanceof, new, null, return, switch, this, throw, true, try, typeof, var, void, while, with},
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]',
  morestring=[b]",
  ndkeywords={class, export, boolean, throw, implements, import, this},
  keywordstyle=\color{blue}\bfseries,
  ndkeywordstyle=\color{darkgray}\bfseries,
  identifierstyle=\color{black},
  commentstyle=\color{purple}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  sensitive=true
}

\lstset{
   language=JavaScript,
   backgroundcolor=\color{lightgray},
   extendedchars=true,
   showstringspaces=false,
   basicstyle=\small,
   showspaces=false,
   numbers=left,
   numberstyle=\footnotesize,
   numbersep=9pt,
   tabsize=2,
   breaklines=true,
   showtabs=false,
   captionpos=b
}

\begin{document}


\title{Beyond .*Script}
\subtitle{Implementing A Language For The Web}

\author{Veit Heller}

\date{\today}

\publishers{%
  \normalsize{%
  A thesis submitted for the degree of \\
  B.Sc. of Applied Computer Science of \\
  The University of Applied Sciences Berlin}}

\uppertitleback{%
  \textbf{Institutional Address}\\
  HTW Berlin\\
  Campus Treskowallee\\
  Treskowallee 8\\
  10318 Berlin\\
  \textsc{Germany}\\
  \bigskip\\
  \textbf{Supervisory Panel}\\

  Prof. Hendrik Gärtner\\
  HTW Berlin\\

  Prof. Henrick Lochmann\\
  Prof. Henrik Lochmann\\
  HTW Berlin\\
  \bigskip\\
  Set with the help of {\KOMAScript} and
  \XeLaTeX.\\

  \copyright~\the\year. All rights reserved.}

\dedication{\small{\emph{For Meredith, Tobias and all the people who cope with me. Your undying support will not be forgotten.}}}

\pdfbookmark{Title Page}{Title Page}
\maketitle

\frontmatter

\vspace*{0.4\textheight}

\begin{center}
  Except where otherwise indicated, this thesis is my own original
  work.
\end{center}
\vspace*{4cm}

\begin{flushright}
  \begin{minipage}{4cm}
    Veit Heller\\
    \today
  \end{minipage}
\end{flushright}

\begin{onehalfspace}
\end{onehalfspace}

\addchap{Abstract}

The modern web is comprised of an abundance of very different beasts. Technologies that powered the first versions of the World Wide Web, such as HTML, CSS and JavaScript, and relatively new conceptions like TypeScript, CoffeScript, PureScript, ClojureScript, Elm, LASS, SCSS, Jade and Emscripten - to name but a few - are shaping the internet as we know it. There is one flaw that many of the new technologies have in common, as different as they may look and feel - they are mere preprocessors. In the end, it all boils down to the classic technologies again and we are left with the same limited capabilities we have had for the last twenty years.

This thesis presents a port of the zepto programming language to the web. It aims to work as seamlessly with existing technologies as possible.

\pdfbookmark{Contents}{Contents}
\tableofcontents

\printglossary[type=\acronymtype,title=Abbreviations]

\mainmatter

\pagestyle{headings}

\setchapterpreamble[u]{%
  \dictum[\emph{B. Kernighan}]{Controlling complexity is the essence of computer programming.}
  \bigskip}
\chapter{Introduction}
\label{chap:intro}

\section{Motivation}

JavaScript has, since its inception, attracted a lot of controversy. This is rooted
in various aspects of its design, from prototypal inheritance to operator precedence.
Prototypal inheritance has the reputation of being counter-intuitive, though it is older
than JavaScript, the first commonly known programming language that implements prototypal
objects being Self.


* things get better

* es 6 and es7 thank god

* a lot of research funneled into it

* still a fundamental rethinking might be necessary

\section{Purpose of this work}

\section{Structure of this work}

\setchapterpreamble[u]{%
  \dictum[\emph{T. Peters}---The Zen of Python]{Practicality beats purity.}
  \bigskip}
\chapter{Motivation}
\label{chap:Motivation}

A common saying among programming language designers is that every programmer has written
their own implementation of Lisp. There are a lot of different implementations of Lisp
in the wild, even ones that compile to JavaScript\footnote{such as \href{https://github.com/clojure/clojurescript}{ClojureScript},
a backend of the Clojure compiler that targets JavaScript.}.

The main reason for that is often cited to be the simplicity of the language on a parsing
level. A simple Lisp can be implemented in less than one hundred lines of code, if no
intermediate representation is generated. This is made possible by the unique property
of Lisp of enclosing every statement in parentheses, where the first element within
those parentheses is the statement and the other elements are the arguments.
It can be evaluated straight from a textual level, because things such as operator precedence
and statement amiguity do not exist. In regular Lisp as specified in the initial paper by
John McCarthy\parencite{JCM} only six special forms exist to allow not only for Turing-completeness,
but also for expressiveness.

\section{zepto}

Zepto is a new Scheme implementation that aims to be as small as possible, to be able
to target a lot of different backends. Currently, LLVM and Erlang Core\footnote{Erlang Core 
is the \gls{ir} of Erlang code before it is complied. Resources and documentation
about it are sparse, it mostly seems to exist inside the BEAM's implementation.} bindings are
under development, the reference implementation is a simple interpreter that interprets code
directly from the \gls{ast}. This is slow but ensures a small interpreter size\footnote{The
entire codebase is only about 4000 lines of Haskell code big}. The compilers are written directly
in zepto itself.

The small code base makes zepto a good target for porting it to the web. Further, ecause it
is written in Haskell the code base was expected to be possibly almost entirely compilable
to JavaScript using GHC-JS, a backend for the \gls{ghc} targetting JavaScript instead of
native code. It offers many advanced features such as inlining of JavaScript into the code
base using a technique called quasi-quoting, where a special character sequence delimits the
inlined code, much like regular quotes. This tool set was expected to make the work of porting
an existing language to the web as simple as possible.

Of course there are other reasons to use a functional language as an example. With both syntax
and semantics differing wildly from JavaScript, this example makes way for languages more
closely related to JavaScript also making their eventual way into the browser.

\setchapterpreamble[u]{%
  \dictum[\emph{Hofstadter’s Law}]{It always takes longer than you expect, even when you take into account Hofstadter’s Law.}
  \bigskip}
\chapter{Implementation}
\label{chap:Implementation}

As predicted in \ref{chap:Motivation}, the code base of zepto could be reused in almost its' entirety.
What had to be rewritten was mostly related to the startup of the interpreter, because the regular
paths into the code - either via a script being passed into it or launching an interactive
\gls{repl}\footnote{A \gls{repl} is an interactive code evaluation environment. Code is typed into
a prompt and immediately evaluated. The convenience of such a short feedback loop is often used
in the context of scripting languages and shells.} - were unavailable in the browser context.
Instead, a way of passing the sources from within \texttt{script} tags needed to be found. Further
customizations include a \gls{ffi} to enable better cross-evaluation of JavaScript and the adaptation
of existing \gls{api}s, such as the \gls{dom}.

\section{The \texttt{script} tag}

Initially, a \gls{dom} node walker was considered, but rejected relatively early because of two reasons:
Firstly, it introduced a layer of complexity from within JavaScript code that would have likely made
it brittle and hardly portable. Secondly, it would require a walk of the nodes every time a \gls{dom}
element is inserted or replaced, which is a common occurence in modern interactive web applications.

As of November of 2015, the \gls{w3c} specifies an \gls{api} that simplifies this process for the programmer.
Within their specification of the \href{https://www.w3.org/TR/dom/#mutationobserver}{DOM4}, the fourth
specification of \gls{api}s for the Web, an object called \texttt{MutationObserver} is included which
is able to register for \gls{dom} manipulations. Its main function will be triggered whenever a change
occurs within the \gls{dom} part that it registered for listening to.

This simplifies the implementation of a listener to DOM events a great deal. Only minimal programming
is required to configure the listener and to filter out all the nodes that are not \texttt{script} nodes
of the type \texttt{text/zepto}\footnote{This was chosen in analogy to the existing \texttt{text/javascript}
node type}.

A problem untended to with that method was nodes insert before the listener starts. This was resolved by
singling out all the \texttt{script} tags that are present before the listener starts and applying the
same filter/evaluation function to all of them. This also ensures that they are executed before any
additional code (and possibly dependent) is passed into the zepto object.

The code was then included in the \texttt{zepto} object, which is the global interpreter object
used for the management and interactivity of the zepto interpreter\footnote{It also conveniently
serves as the entrypoint for a \gls{ffi} from JavaScript to zepto.}.

\begin{lstlisting}[language=JavaScript,caption=The final mutation observer code (simplified)]
// the initial observer and the function it takes
zepto.observer = new MutationObserver(zepto.handleMutation);

// this function will get a list of mutations and apply handleDom to them
zepto.handleMutation = function(mutations) {
  mutations.forEach(mutation => {
    mutation.addedNodes.map(zepto.handleDom);
  });
}

// evaluate if it is a text/zepto node
zepto.handleDom = function(node) {
  if (node.nodeName != "SCRIPT" || node.type != "text/zepto") {
    return null;
  }
  return zepto.eval(node.innerHTML);
}

// execute this on startup
window.onload = () => {
  let scripts = document.getElementsByTagName("script");
  scripts.map(zepto.handleDom);
}
// the extra arguments signify recursive listening
zepto.observer.observe(document, {childList: true, subtree: true});
\end{lstlisting}

\clearpage

\section{The \gls{ffi}}

The \gls{ffi}

\setchapterpreamble[u]{%
  \dictum[\emph{R. Buckminster Fuller}]{When I'm working on a problem, I never think about beauty. I think only how to solve the problem. But when I have finished, if the solution is not beautiful, I know it is wrong.}
  \bigskip}
\chapter{Outlook}
\label{chap:outlook}


\chapter{Conclusion}
\label{chap:conclusion}


%============================================
%============================================
% end matter

\backmatter

\bookmarksetup{startatroot}

\printbibliography[title=References,heading=bibintoc]

\end{document}
